# This is a simple Makefile for compiling LaTeX documents.
# You'll find the original at https://github.com/pinga-lab/latex_makefile

# Based on the work of
# Joshua Ryan Smith (https://github.com/jrsmith3/latex_template)
# and
# Jason Hiebel (https://github.com/JasonHiebel/latex.makefile)

# CONFIGURATION
###############################################################################

# The name of the main .tex file to build.
# Other files can be included into this one.
PROJECT = manuscript
R1 = $(PROJECT)-marked-R1
# Folder where the figure files are (will assume they are EPS format)
FIGDIR = figures
# Folder where the BibTex .bib files are
BIBDIR = .
# Folder where the .cls .bst and .sty style files are
STYLEDIR = .

### File Types (for dependencies)
BIB = $(shell ls $(BIBDIR)/'*.bib')
STY = $(shell ls $(STYLEDIR)/'*.sty')
CLS = $(shell ls $(STYLEDIR)/'*.cls')
BST = $(shell ls $(STYLEDIR)/'*.bst')
EPS = $(shell ls $(FIGDIR)/'*.eps')
PNGS = $(patsubst %.eps,%.png,$(EPS))
EXTRA = profiling.tex

### Compilation Flags
LATEX_FLAGS  = -halt-on-error

### Standard PDF Viewers
UNAME := $(shell uname)
ifeq ($(UNAME), Linux)
PDFVIEWER = okular
endif
ifeq ($(UNAME), Darwin)
PDFVIEWER = open
endif


# MAIN TARGETS
###############################################################################

all: $(PROJECT).pdf

show: all
	@ # Redirect stdout and stderr to /dev/null for silent execution
	@ (${PDFVIEWER} $(PROJECT).pdf > /dev/null 2>&1 & )

wc: all
	@ pdftotext $(PROJECT).pdf - | wc -w

### Clean
# This target cleans the temporary files generated by the tex programs
clean:
	rm -rf *.aux *.log *.bbl *.blg *.out
	rm -rf $(PROJECT).pdf
	rm -rf $(FIGS)/*-eps-converted-to.pdf

# Remove embedded fonts from the figure EPS files. The GJI system doesn't like
# them.
stripfonts:
	cd $(FIGS); bash strip-fonts.sh

# Convert images to PNG
pngs: $(PNGS)

%.png: %.eps
	bash $(FIGDIR)/topng.sh $<

# BUILD THE SOURCES
###############################################################################

%.pdf: %.tex $(STY) $(CLS) $(BIB) $(BST) $(EPS) $(EXTRA)
	pdflatex $(LATEX_FLAGS) $< 1>/dev/null
	bibtex $(patsubst %.tex,%,$<)
	pdflatex $(LATEX_FLAGS) $< 1>/dev/null
	pdflatex $(LATEX_FLAGS) $< 


# MAKE THE VERSION WITH MARKED DIFFERENCES
###############################################################################

r1: $(R1).pdf

$(R1).tex: $(PROJECT).tex $(STY) $(CLS) $(EPS) $(EXTRA)
	git ldiff submission $< > $@
